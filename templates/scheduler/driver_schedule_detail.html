{% extends "scheduler/base.html" %}

{% block title %}Schedule Details{% endblock %}
{% block content %}
<div class="container mt-5">
  <div class="row">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">{{ schedule_entry.client_name }}</h5>
          <p class="card-text">
            <strong>Date:</strong> {{ schedule_entry.date }}<br>
            <strong>Time:</strong> {{ schedule_entry.start_time }} – {{ schedule_entry.end_time }}<br>
            <strong>Address:</strong> {{ schedule_entry.address }}
          </p>

          {% if not schedule_entry.is_completed %}
            <form action="{% url 'scheduler:mark_as_completed' schedule_entry.pk %}" method="post">
              {% csrf_token %}
              <button type="submit" class="btn btn-primary mt-3">Mark as Completed</button>
            </form>
          {% else %}
            <div class="alert alert-success mt-3" role="alert">
              Trip completed at {{ schedule_entry.completed_at|date:"P" }}.
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Route Map</h5>
          <div id="map" style="height: 400px; border-radius: 0.5rem;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin="anonymous"></script>

<script>
  // Embed schedule coords (null if not set)
  const startLat = {{ schedule_entry.start_latitude|default_if_none:"null" }};
  const startLng = {{ schedule_entry.start_longitude|default_if_none:"null" }};
  const endLat   = {{ schedule_entry.end_latitude|default_if_none:"null" }};
  const endLng   = {{ schedule_entry.end_longitude|default_if_none:"null" }};

  // Default coordinates (e.g. HQ or service area)
  const defaultLat = 42.60055;
  const defaultLng = -71.34866;

  const mapEl = document.getElementById('map');

  // Use entry coords if available, otherwise default
  let mapCenter = [defaultLat, defaultLng];
  if (startLat !== null && startLng !== null) {
    mapCenter = [startLat, startLng];
  }

  const map = L.map('map').setView(mapCenter, 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  if (startLat !== null && startLng !== null) {
    L.marker([startLat, startLng]).addTo(map).bindPopup('Start');
  }
  if (endLat !== null && endLng !== null) {
    L.marker([endLat, endLng]).addTo(map).bindPopup('Destination');
    const line = L.polyline([[startLat, startLng], [endLat, endLng]]).addTo(map);
    map.fitBounds(line.getBounds(), { padding: [20, 20] });
  } else if (startLat === null || startLng === null) {
    // No schedule coords at all → just show default marker
    L.marker([defaultLat, defaultLng]).addTo(map).bindPopup('Default Location');
  }
</script>
{% endblock %}
