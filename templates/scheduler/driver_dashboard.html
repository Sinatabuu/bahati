
{% extends "scheduler/base.html" %}
{% load static %}

{% block extra_head %}
  {{ block.super }}
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin="anonymous">
  <style>
    .wrap { display: grid; gap: 12px; }
    .panel { background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .panel-h { padding:10px 12px; border-bottom:1px solid #eef2f7; display:flex; align-items:center; gap:10px; justify-content:space-between; }
    .panel-b { padding:12px; }
    .sticky-head { position:sticky; top:56px; z-index:5; background:#fff; border-bottom:1px dashed #e5e7eb; }
    .h-controls { display:flex; gap:10px; align-items:center; }
    .trips { display:flex; flex-direction:column; gap:10px; }
    .trip { border:1px solid #e6e8ef; border-radius:12px; padding:12px; display:grid; gap:10px; }
    .meta { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .time { font-variant-numeric: tabular-nums; background:#0d1b2a; color:#fff; padding:4px 10px; border-radius:999px; font-weight:700; }
    .status { border-radius:999px; padding:2px 8px; font-weight:700; font-size:.8rem; border:1px solid #e5e7eb; color:#374151; background:#eef2ff; text-transform:capitalize; }
    .status.completed { background:#d1fae5; border-color:#bbf7d0; color:#065f46; }
    .title { font-weight:800; font-size:1rem; color:#111827; }
    .kv { display:grid; grid-template-columns: 18px 1fr; gap:8px; font-size:.96rem; }
    .kv .i { text-align:center; color:#6b7280; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .btn-big { padding:10px 14px; font-weight:700; border-radius:12px; border:1px solid #e5e7eb; background:#fff; min-height:42px; }
    .btn-nav { background:#0d6efd; color:#fff; border-color:#0d6efd; }
    .btn-complete { background:#0f766e; color:#fff; border-color:#0f766e; }
    .hint { color:#6b7280; font-size:.85rem; }
    #miniMap { height: 220px; border-radius:12px; border:1px solid #e5e7eb; }
    @media (min-width: 768px) {
      .wrap { grid-template-columns: minmax(0, 1fr) 360px; align-items:start; }
      #miniMap { height: 380px; }
    }
    .btn-small {
      appearance:none; border:1px solid #e5e7eb; background:#111827; color:#fff;
      padding:6px 10px; border-radius:10px; text-decoration:none; font-size:.9rem;
    }
    .btn-small:hover { filter:brightness(1.03); }
    .muted { color:#6b7280; font-size:.9rem; }
  </style>
{% endblock %}


{% block title %}Driver Dashboard · Bahati [LIVE DEBUG]{% endblock %}

{% block content %}

<div class="container my-3">
  <h2 class="h5 mb-2">
    <i class="fa-solid fa-steering-wheel"></i>
    Driver Dashboard —
    <strong>{{ driver_display_name|default:"Driver" }}</strong>
  </h2>

  <div class="wrap" id="dd">
    <!-- LEFT: trips -->
    <section class="panel">
      <div class="panel-h sticky-head">
  <div class="h-controls">
    <label class="muted">Date</label>
    <input id="d-date"
           type="date"
           class="form-control"
           value="{{ day|date:'Y-m-d' }}" />
  </div>

  {% if request.user.is_staff %}
    <a class="btn-small"
       href="/service/schedule-list/?day={{ day|date:'Y-m-d' }}">
      All Schedules (view-only)
    </a>
  {% endif %}
</div>

      <div class="panel-b">
        <div id="trip-list" class="trips">
          {% for t in trips %}
            <article class="trip"
                     data-id="{{ t.id }}"
                     data-pickup-lat="{{ t.pickup_latitude|default_if_none:'' }}"
                     data-pickup-lng="{{ t.pickup_longitude|default_if_none:'' }}"
                     data-client="{{ t.client }}">
              <div class="meta">
                <span class="time">{{ t.time_str }}</span>
                <span class="status {% if t.status == 'completed' %}completed{% endif %}">
                  {{ t.status }}
                </span>
                {% if t.vehicle_name %}
                  <span class="badge bg-light text-dark border">{{ t.vehicle_name }}</span>
                {% endif %}
              </div>

              <div class="title">
                {{ t.client }}
              </div>

              <div class="kv">
                <div class="i"><i class="fa-solid fa-signs-post"></i></div>
                <div>
                  <strong>Pickup:</strong>
                  {{ t.pickup_address }}
                  {% if t.pickup_city %}, {{ t.pickup_city }}{% endif %}
                </div>

                <div class="i"><i class="fa-solid fa-location-dot"></i></div>
                <div>
                  <strong>Dropoff:</strong>
                  {{ t.dropoff_address }}
                  {% if t.dropoff_city %}, {{ t.dropoff_city }}{% endif %}
                </div>
              </div>

              <div class="actions">
		  {% if t.nav_pickup_url %}
    		<a class="btn-big btn-nav"
       		href="{{ t.nav_pickup_url }}"
       		target="_blank" rel="noopener">Pickup</a>
	      {% endif %}

              {% if t.nav_dropoff_url %}
             <a class="btn-big btn-nav"
       	     href="{{ t.nav_dropoff_url }}"
       	    target="_blank" rel="noopener">Dropoff</a>
  	    {% elif t.route_url %}
    	    <a class="btn-big btn-nav"
       	    href="{{ t.route_url }}"
            target="_blank" rel="noopener">Dropoff</a>
 	 {% endif %}

  	<button class="btn-big btn-complete" data-action="completed">Complete</button>
	</div>

            </article>
          {% empty %}
            <div id="empty" class="text-center text-muted py-4">
              No trips for this date.
            </div>
          {% endfor %}
        </div>

        {% if trips %}
          <div id="empty" class="text-center text-muted py-4" style="display:none">
            No trips for this date.
          </div>
        {% endif %}
      </div>
    </section>

    <!-- RIGHT: map -->
    <section class="panel">
      <div class="panel-h">
        <strong><i class="fa-solid fa-map-location-dot"></i> Map</strong>
        <small class="hint">Tap “Navigate” for turn-by-turn</small>
      </div>
      <div class="panel-b">
        <div id="miniMap"></div>
      </div>
    </section>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script>
(function(){
  const root   = document.getElementById('dd');
  if (!root) return;

  const elDate  = document.getElementById('d-date');
  const elList  = document.getElementById('trip-list');
  const elEmpty = document.getElementById('empty');

  // --- Date picker: reload page with ?date=YYYY-MM-DD&me=1 ---
  if (elDate) {
    elDate.addEventListener('change', () => {
      const val = elDate.value;
      if (!val) return;
      const url = new URL(window.location.href);
      url.searchParams.set('date', val);
      url.searchParams.set('me', '1');
      window.location.href = url.toString();
    });
  }

  // --- CSRF helper for POST ---
  function getCookie(name){
    return document.cookie.split(';').map(v => v.trim())
      .find(v => v.startsWith(name + '='))?.split('=')[1] || '';
  }
  const CSRF = getCookie('csrftoken');

  // --- Map setup ---
  let map = L.map('miniMap', { scrollWheelZoom:true, tap:true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let markers = [];
  function addMarker(lat, lng, html){
    try {
      const mk = L.marker([lat, lng]).addTo(map).bindPopup(html || '');
      markers.push(mk);
      return mk;
    } catch (e) {
      return null;
    }
  }

  const cards = elList ? elList.querySelectorAll('.trip') : [];
  let anyMarkers = false;

  cards.forEach(card => {
    const clientName = card.dataset.client || '';
    const lat = parseFloat(card.dataset.pickupLat || card.getAttribute('data-pickup-lat') || '');
    const lng = parseFloat(card.dataset.pickupLng || card.getAttribute('data-pickup-lng') || '');

    // Add markers for pickup locations if we have coords
    if (!isNaN(lat) && !isNaN(lng)) {
      addMarker(lat, lng, '<strong>' + clientName + '</strong>');
      anyMarkers = true;
    }

    const entryId    = card.dataset.id;
    const statusEl   = card.querySelector('.status');
    const btnComplete = card.querySelector('[data-action="completed"]');

    function setStatus(status){
      if (!statusEl) return;
      statusEl.textContent = status;
      statusEl.classList.toggle('completed', status === 'completed');
    }

    // --- Activate Complete button ---
    if (btnComplete && entryId) {
      btnComplete.addEventListener('click', async () => {
        btnComplete.disabled = true;
        try {
          const resp = await fetch('/service/api/schedule/status/', {
            method: 'POST',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': CSRF
            },
            body: JSON.stringify({ entry_id: entryId, status: 'completed' })
          });

          const text = await resp.text();
          let data = {};
          try { data = JSON.parse(text); } catch (e) {}

          if (!resp.ok || data.ok === false) {
            throw new Error(data.error || 'Status update failed');
          }

          // Update pill to "completed" and green
          setStatus('completed');
        } catch (e) {
          alert(e.message || 'Status update failed');
        } finally {
          btnComplete.disabled = false;
        }
      });
    }
  });

  // Center map
  if (!anyMarkers) {
    map.setView([42.3601, -71.0589], 9);   // Default Boston-ish
  } else {
    const group = L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.2), { animate:false });
  }

  // Empty state visibility
  if (elEmpty) {
    elEmpty.style.display = cards.length ? 'none' : 'block';
  }
})();
</script>
{% endblock %}

